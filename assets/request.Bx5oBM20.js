import{ah as e,N as t,Y as s,k as n,l as r,W as o,R as a,V as i,Z as c,$ as u}from"./vendor.Ckgv2xgH.js";const h="https://qimtehpdnqohvmzoghpm.supabase.co".trim(),l="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpbXRlaHBkbnFvaHZtem9naHBtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMjQ5NTEsImV4cCI6MjA3OTgwMDk1MX0.bsH51QQTflJGZNtaXSpaSVXPMWzmTa4rQSw8HMXRhlo".trim();console.log("Supabase 最终初始化 URL:",h),h&&l||console.error("Supabase 必须的配置项缺失，请检查环境变量。");const d=e(h.startsWith("http")?h:"https://placeholder.supabase.co",l||"placeholder"),g="API",f="UNKNOWN",p={NETWORK:"网络连接失败，请检查您的网络设置",API:"服务异常，请稍后重试",VALIDATION:"数据验证失败",PERMISSION:"没有访问权限",UNKNOWN:"未知错误，请联系客服"};function I(e,s=!0){return function(e,s=f,n=!0){console.error(`[${s}]`,e);let r=p[s]||p.UNKNOWN;return s===g&&e.message&&(r=e.message),n&&t({title:r,icon:"none",duration:2500}),{type:s,message:r,originalError:e}}(e,g,s)}const y={async getUserProfile(e=5){const t=await N(async()=>d.from("users").select("*").eq("id",e).single(),{requestId:`user_profile_${e}`,showLoading:!1});return t?t.data:null}},m=s("user",()=>{const e=n(null),t=n(""),s=r(()=>!!e.value&&!!t.value),a=t=>{e.value=t},i=e=>{t.value=e},c=async()=>{const e=await y.getUserProfile();e&&a(e)};return{userInfo:e,token:t,isLogin:s,setUserInfo:a,setToken:i,login:async e=>(i("demo-token-12345"),await c(),!0),getUserProfile:c,logout:()=>{e.value=null,t.value="",o({url:"/pages/index/index"})}}},{persist:{key:"gemini-auth-session",paths:["userInfo","token"],storage:{getItem:e=>i(e),setItem:(e,t)=>a(e,t)}}}),q={showLoading:!0,showError:!0,loadingText:"加载中...",checkToken:!0};const w=new class{constructor(e=5){this.concurrency=e,this.queue=[],this.runningCount=0,this.cache=new Map,this.pendingRequests=new Set}add(e,t){return new Promise((s,n)=>{const r={fn:e,config:t,resolve:s,reject:n,retries:t.retries||0};if(t.cacheKey){const e=this.getCache(t.cacheKey);if(e)return s(e)}this.queue.push(r),this.processQueue()})}async processQueue(){if(this.runningCount>=this.concurrency||0===this.queue.length)return;this.runningCount++;const e=this.queue.shift();if(e.config.requestId&&this.pendingRequests.has(e.config.requestId))return e.reject({message:"请求重复"}),this.runningCount--,void this.processQueue();e.config.requestId&&this.pendingRequests.add(e.config.requestId);try{const t=await this.executeTask(e);e.config.cacheKey&&this.setCache(e.config.cacheKey,t),e.resolve(t)}catch(t){e.retries>0&&this.isNetworkError(t)?(console.warn(`请求失败，重试中 (${e.retries} left)`),e.retries--,this.queue.push(e)):e.reject(t)}finally{e.config.requestId&&this.pendingRequests.delete(e.config.requestId),this.runningCount--,this.processQueue()}}async executeTask(e){const{showLoading:t,loadingText:s}=e.config;t&&c({title:s||"加载中..."});try{const t=await e.fn();if(t&&t.error)throw t.error;return{success:!0,data:t&&"object"==typeof t&&"data"in t?t.data:t,count:t?t.count:void 0}}finally{t&&u()}}getCache(e){const t=this.cache.get(e);return t?Date.now()>t.expiry?(this.cache.delete(e),null):t.data:null}setCache(e,t,s=6e4){this.cache.set(e,{data:t,expiry:Date.now()+s})}isNetworkError(e){return!e.code||"NETWORK_ERROR"===e.code}}(5);async function N(e,t={}){const s={...q,...t},{checkToken:n,cache:r,cacheKey:o}=s,a=m();n&&!a.token&&console.warn("请求拦截：无有效 Token，请先登录"),!o&&s.requestId&&(s.cacheKey=s.requestId),!r||o||s.requestId||(s.cacheKey=t.tableName?`${t.tableName}_${JSON.stringify(t.filters||{})}`:null);try{return await w.add(e,s)}catch(i){const e=I(i,s.showError);return"PGRST301"!==i.code&&401!==i.status||a.logout(),{success:!1,error:e,data:null}}}const k=(e,t,s)=>N(()=>d.from(e).select("*").eq("id",t).single(),s),T=(e,t,s)=>N(()=>d.from(e).insert([t]).select(),{loadingText:"提交中...",...s}),R=(e,t,s,n)=>N(()=>d.from(e).update(s).eq("id",t).select(),{loadingText:"保存中...",...n}),b=(e,t,s)=>N(()=>d.from(e).delete().eq("id",t),{loadingText:"删除中...",...s});export{b as a,R as b,T as i,k as q,N as r,d as s,m as u};
