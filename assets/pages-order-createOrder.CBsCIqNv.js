import{_ as e,k as a,U as l,ad as s,p as t,ae as u,t as o,V as r,l as n,D as c,a as d,c as i,L as f,w as v,F as p,v as _,x as m,M as y,y as g,o as k,B as h,C,H as b,E as w,G as x,P as I,J as j,N as A,Z as q,$ as z}from"./vendor.Ckgv2xgH.js";import{a as F}from"./address.BOahIuM3.js";import{m as L}from"./marketing.B3uJcO8V.js";import{u as M}from"./request.Bx5oBM20.js";import{u as $}from"./useSystem.Wa4UmrYm.js";import{o as E}from"./order.CbSw1ZKD.js";const N=e({__name:"createOrder",setup(e){const N=M(),{navTo:O}=$(),U=a(null),B=a([]),D=a([]),G=a(null),H=a(!1);l(()=>{s("selectAddress",e=>{U.value=e})}),t(()=>{u("selectAddress")}),o(async()=>{var e,a;if(B.value=r("temp_order_items")||[],!U.value&&(null==(e=N.userInfo)?void 0:e.id)){const e=await F.getAddressList(N.userInfo.id);e&&e.length>0&&(U.value=e.find(e=>e.is_default)||e[0])}if(null==(a=N.userInfo)?void 0:a.id){const e=await L.getMyCoupons(N.userInfo.id);e&&(D.value=e.filter(e=>1===e.status))}});const J=n(()=>{let e=0;return B.value.forEach(a=>{e+=Number(a.price)*a.qty}),e}),P=n(()=>D.value.filter(e=>{var a;const l=(null==(a=e.coupons)?void 0:a.min_amount)||0;return J.value>=l})),S=n(()=>{var e;let a=J.value;return G.value&&(a-=(null==(e=G.value.coupons)?void 0:e.money)||0),Math.max(0,a).toFixed(2)}),T=e=>{G.value=e,V()},V=()=>{H.value=!H.value},Z=()=>{O("/pages/address/address")},K=async()=>{var e;if(!U.value)return void A({title:"请选择收货地址",icon:"none"});if(q({title:"创建订单中"}),!(null==(e=N.userInfo)?void 0:e.id))return z(),void A({title:"请先登录",icon:"none"});const a={userId:N.userInfo.id,address:U.value,totalAmount:J.value,finalAmount:S.value,goodsList:B.value,remark:""},l=await E.createOrder(a);if(l.error)return z(),void A({title:"创建订单失败: "+l.error,icon:"none"});const s=l.orderId;if(G.value){const e=await L.useUserCoupon(G.value.id);e.error&&console.error("优惠券核销失败，但订单已创建:",e.error)}z(),O(`/pages/money/pay?amount=${S.value}&id=${s}`)};return(e,a)=>{const l=h,s=_,t=m(g("uni-icons"),y),u=x,o=j;return k(),c(p,null,[d(s,{class:"container"},{default:v(()=>[d(s,{class:"address-section",onClick:Z},{default:v(()=>[U.value?(k(),i(s,{key:0,class:"order-content"},{default:v(()=>[d(l,{class:"name"},{default:v(()=>[C(b(U.value.name),1)]),_:1}),d(l,{class:"mobile"},{default:v(()=>[C(b(U.value.phone),1)]),_:1}),d(l,{class:"addr"},{default:v(()=>[C(b(U.value.province)+" "+b(U.value.city)+" "+b(U.value.area)+" "+b(U.value.address),1)]),_:1})]),_:1})):(k(),i(s,{key:1,class:"order-content"},{default:v(()=>[d(l,{class:"no-addr"},{default:v(()=>[C("请选择收货地址")]),_:1})]),_:1})),d(t,{type:"right",size:"14",color:"#ccc"})]),_:1}),d(s,{class:"goods-section"},{default:v(()=>[(k(!0),c(p,null,w(B.value,(e,a)=>(k(),i(s,{class:"g-item",key:a},{default:v(()=>[d(u,{src:e.image,mode:"aspectFill",class:"g-img"},null,8,["src"]),d(s,{class:"g-info"},{default:v(()=>[d(l,{class:"g-title"},{default:v(()=>[C(b(e.title),1)]),_:2},1024),d(l,{class:"g-attr"},{default:v(()=>[C(b(e.attr),1)]),_:2},1024),d(s,{class:"g-price-box"},{default:v(()=>[d(l,{class:"g-price"},{default:v(()=>[C("¥"+b(e.price),1)]),_:2},1024),d(l,{class:"g-number"},{default:v(()=>[C("x "+b(e.qty),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1}),d(s,{class:"price-section"},{default:v(()=>[d(s,{class:"row"},{default:v(()=>[d(l,{class:"tit"},{default:v(()=>[C("商品金额")]),_:1}),d(l,{class:"price"},{default:v(()=>[C("¥"+b(J.value),1)]),_:1})]),_:1}),d(s,{class:"row"},{default:v(()=>[d(l,{class:"tit"},{default:v(()=>[C("运费")]),_:1}),d(l,{class:"price"},{default:v(()=>[C("¥0.00")]),_:1})]),_:1}),d(s,{class:"row",onClick:V},{default:v(()=>[d(l,{class:"tit"},{default:v(()=>[C("优惠券")]),_:1}),d(s,{class:"right-box"},{default:v(()=>[G.value?(k(),i(l,{key:0,class:"price red"},{default:v(()=>{var e;return[C("-¥"+b((null==(e=G.value.coupons)?void 0:e.money)||0),1)]}),_:1})):(k(),i(l,{key:1,class:"tip"},{default:v(()=>[C(b(P.value.length>0?P.value.length+"张可用":"无可用"),1)]),_:1})),d(t,{type:"right",size:"14",color:"#ccc"})]),_:1})]),_:1})]),_:1}),d(s,{class:"footer-bar"},{default:v(()=>[d(s,{class:"total-box"},{default:v(()=>[d(l,null,{default:v(()=>[C("实付款:")]),_:1}),d(l,{class:"price"},{default:v(()=>[C("¥"+b(S.value),1)]),_:1})]),_:1}),d(s,{class:"submit-btn",onClick:K},{default:v(()=>[C("提交订单")]),_:1})]),_:1})]),_:1}),H.value?(k(),i(s,{key:0,class:"popup-mask",onClick:V},{default:v(()=>[d(s,{class:"popup-content",onClick:a[1]||(a[1]=I(()=>{},["stop"]))},{default:v(()=>[d(s,{class:"popup-header"},{default:v(()=>[d(l,null,{default:v(()=>[C("选择优惠券")]),_:1}),d(t,{type:"closeempty",size:"20",onClick:V})]),_:1}),d(o,{"scroll-y":"",class:"popup-scroll"},{default:v(()=>[(k(!0),c(p,null,w(P.value,(e,a)=>(k(),i(s,{class:"coupon-item",key:a,onClick:a=>T(e)},{default:v(()=>[d(s,{class:"left"},{default:v(()=>[d(l,{class:"symbol"},{default:v(()=>[C("¥")]),_:1}),d(l,{class:"money"},{default:v(()=>{var a;return[C(b(null==(a=e.coupons)?void 0:a.money),1)]}),_:2},1024)]),_:2},1024),d(s,{class:"right"},{default:v(()=>{var a;return[d(s,{class:"info"},{default:v(()=>[d(l,{class:"name"},{default:v(()=>{var a;return[C(b(null==(a=e.coupons)?void 0:a.name),1)]}),_:2},1024),d(l,{class:"cond"},{default:v(()=>{var a;return[C(b(null==(a=e.coupons)?void 0:a.condition),1)]}),_:2},1024)]),_:2},1024),(null==(a=G.value)?void 0:a.id)===e.id?(k(),i(t,{key:0,type:"checkmarkempty",size:"20",color:"#fa436a"})):f("",!0)]}),_:2},1024)]),_:2},1032,["onClick"]))),128)),0===P.value.length?(k(),i(s,{key:0,class:"empty-tip"},{default:v(()=>[C("暂无可用优惠券")]),_:1})):f("",!0)]),_:1}),d(s,{class:"popup-footer",onClick:a[0]||(a[0]=e=>T(null))},{default:v(()=>[d(l,null,{default:v(()=>[C("不使用优惠券")]),_:1})]),_:1})]),_:1})]),_:1})):f("",!0)],64)}}},[["__scopeId","data-v-77d3e186"]]);export{N as default};
