import{N as r}from"./vendor.Ckgv2xgH.js";import{r as s,s as o}from"./request.Bx5oBM20.js";const e={async getAvailableCoupons(){const r=await s(async()=>o.from("coupons").select("*").eq("status",!0).order("money",{ascending:!1}),{requestId:"available_coupons"});return r&&r.data?r.data:[]},async receiveCoupon(e,t){if(!t)return r({title:"请先登录",icon:"none"}),{error:"未登录"};const a=await s(async()=>{const{data:r}=await o.from("user_coupons").select("id").eq("user_id",t).eq("coupon_id",e).limit(1);if(r&&r.length>0)return{error:"您已经领取过该优惠券了"};const{error:s}=await o.from("user_coupons").insert({user_id:t,coupon_id:e,status:1});if(s)throw s;return await o.rpc("decrement_coupon_stock",{coupon_id:e}),{success:!0}},{showLoading:!0,loadingText:"领取中"});return a&&a.data&&a.data.error?a.data:a&&a.success?{success:!0}:{error:"领取失败，请稍后再试"}},async getMyCoupons(r){const e=await s(async()=>o.from("user_coupons").select("\n                    *,\n                    coupons (*)\n                ").eq("user_id",r).order("created_at",{ascending:!1}),{requestId:`my_coupons_${r}`,showLoading:!0});return e&&e.data?e.data:[]},async useUserCoupon(r){if(!r)return{error:"无效的优惠券ID"};const e=await s(async()=>{const{data:s,error:e}=await o.rpc("use_coupon_bypass_rls",{target_coupon_id:r});if(e)throw e;if(!1===s)throw new Error("核销失败：无效的优惠券ID");return{success:!0}},{showLoading:!0,loadingText:"核销中"});return e&&e.success?{success:!0}:{error:"核销失败"}}};export{e as m};
